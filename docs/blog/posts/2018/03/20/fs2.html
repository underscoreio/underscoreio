<!DOCTYPE html>
<html lang="en" id="/blog/posts/2018/03/20/fs2" class="">
  
  
  <head>
    <title>Tips for working with FS2 - Underscore</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link type="text/css" rel="stylesheet" href="/assets/screen-9132d4f189ef656eb3d1e8defedf7c83e32e9240d9a3af3d804d36f850e43dd5.css">
    <link type="text/css" rel="stylesheet" href="/assets/print-dd04f6182ddcf193d2ac9f59bdbdbb366e01738f8a32086ffb82c7be2f9e1eb8.css" media="print">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@underscoreio">
    
      <meta name="twitter:title" content="Tips for working with FS2">
    
    
      <meta name="twitter:description" content="The streaming library fs2 has had major improvements in their latest release (v0.10), and libraries like Http4s v0.18 have adopted this newest version. As you work more with fs2 and Http4s there are some things you should be aware of, as they will make the journey easier. Specifically, we will look at how to work with flatMap in Streams and at Topics, along some minor comments on fs2 Streams. Those are some hints which I, as someone not very familiar with fs2 at the time, wish I had known sooner.

">
    
    
      <meta name="twitter:image" content="http://underscore.io/images/twitter-card-icon.png">
    

    <link rel="shortcut icon" href="/images/favicon-64.png">
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/blog/feed.xml">

    <link rel="canonical" href="http://underscore.io/blog/posts/2018/03/20/fs2.html">

    <script type="text/javascript" src="/assets/site-5ab8e41df06f32ccfbf4c40fdf2d7fc81c360b991aa5c153ed01fd0714c019d4.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/"><span class="icon-uio-underscore "></span></a>
    </div>

    <div class="navbar-collapse">
      <ul class="nav navbar-nav navbar-right visible-md visible-lg">
        <li class="divider"></li>
        <li class="social"><a href="http://twitter.com/underscoreio"><span class="icon-uio-twitter "></span><span class="sr-only">Twitter</span></a></li>
        <li class="social"><a href="/contact"><span class="icon-uio-envelope "></span><span class="sr-only">Email</span></a></li>
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li class="visible-xs "><a href="/">Home</a></li>
        <li class=""><a href="/development">Development</a></li>
        <li class=""><a href="/consulting">Consulting</a></li>
        <li class=""><a href="/training">Training</a></li>
        <!-- li class=""><a href="/books">Books</a></li -->
        <li class=""><a href="/company">Company</a></li>
      </ul>
    </div>
  </div>
</nav>


<div class="hero">
  <div class="overlay-gem-left-white hero-overlay-soft"></div>
  <div class="overlay-gem-right-white hero-overlay-soft"></div>
  <div class="overlay-arrow-white-inverse"></div>

  <nav class="navbar navbar-inverse" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/"><span class="icon-uio-underscore "></span></a>
    </div>

    <div class="navbar-collapse">
      <ul class="nav navbar-nav navbar-right visible-md visible-lg">
        <li class="divider"></li>
        <li class="social"><a href="http://twitter.com/underscoreio"><span class="icon-uio-twitter "></span><span class="sr-only">Twitter</span></a></li>
        <li class="social"><a href="/contact"><span class="icon-uio-envelope "></span><span class="sr-only">Email</span></a></li>
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li class="visible-xs "><a href="/">Home</a></li>
        <li class=""><a href="/development">Development</a></li>
        <li class=""><a href="/consulting">Consulting</a></li>
        <li class=""><a href="/training">Training</a></li>
        <!-- li class=""><a href="/books">Books</a></li -->
        <li class=""><a href="/company">Company</a></li>
      </ul>
    </div>
  </div>
</nav>


  <header class="hero-text">
    <div class="container">
      
        <h1>
          <a class="back-link" href="/blog">
            Blog
            <span class="icon-uio-back "></span>
          </a>
        </h1>
      

      
    </div>
  </header>
</div>


<section class="container">
  <div class="row">
    <div class="col-md-8">
      <section class="blog-post" data-post-url="/blog/posts/2018/03/20/fs2.html">
        <h2 class="blog-post-title">Tips for working with FS2</h2>

        <dl class="blog-post-meta">
  <dt class="blog-post-date">Posted</dt>
  <dd class="blog-post-date">
    <span class="day">20</span>
    <span class="month">Mar</span>
    <span class="year">2018</span>
  </dd>
  <dt class="blog-post-author">by</dt>
  <dd class="blog-post-author">
    Pere Villega
  </dd>
  
</dl>


        <article class="blog-post-content">
          <p>The streaming library <a href="https://functional-streams-for-scala.github.io/fs2/">fs2</a> has had major improvements in their latest release (v0.10), and libraries like <a href="http://http4s.org">Http4s</a> v0.18 have adopted this newest version. As you work more with fs2 and Http4s there are some things you should be aware of, as they will make the journey easier. Specifically, we will look at how to work with <code class="language-plaintext highlighter-rouge">flatMap</code> in Streams and at <code class="language-plaintext highlighter-rouge">Topics</code>, along some minor comments on fs2 <code class="language-plaintext highlighter-rouge">Streams</code>. Those are some hints which I, as someone not very familiar with fs2 at the time, wish I had known sooner.</p>

<!-- break -->

<p><strong>EDIT:</strong> This post has been updated thanks to feedback from <em>Fabio Labella</em> (<code class="language-plaintext highlighter-rouge">@SystemFw</code> in Gitter) on the <code class="language-plaintext highlighter-rouge">Topics</code> section.</p>

<p>Without further ado, let’s talk about some ‘gotchas’ we may find when working with <a href="https://functional-streams-for-scala.github.io/fs2/">fs2</a>.</p>

<h1 id="everything-is-a-stream">Everything is a Stream</h1>

<p>When you come from a non-FP world, something slightly surprising when you start working with <a href="https://functional-streams-for-scala.github.io/fs2/">fs2</a> is the fact everything is a <code class="language-plaintext highlighter-rouge">Stream</code>. By everything I mean <em>everything</em>, even your <code class="language-plaintext highlighter-rouge">Queue</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val queue: Stream[F, Queue[F, String]] = Stream.eval(async.circularBuffer[F, String](5))
</code></pre></div></div>

<p>The snippet above is the official example on how to create a <code class="language-plaintext highlighter-rouge">Queue</code>. Granted, we can do the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val queue: F[Queue[F, String]] = async.circularBuffer[F, String](5)
</code></pre></div></div>

<p>but given that working with <code class="language-plaintext highlighter-rouge">Stream</code> is easier than working with <code class="language-plaintext highlighter-rouge">F[_]</code>, we probably should stick to the first example.</p>

<p>The fact that a <code class="language-plaintext highlighter-rouge">Queue</code> is a stream means the interaction with the <code class="language-plaintext highlighter-rouge">Queue</code> itself happens inside a <code class="language-plaintext highlighter-rouge">flatMap</code> call, as in this example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import cats.effect.{ Effect, IO }
import fs2._
import fs2.async.mutable.Queue
import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.duration._

object SampleCode extends App {
  val queue: Stream[IO, Queue[IO, String]] = Stream.eval(async.circularBuffer[IO, String](5))

  val element: Stream[IO, String] = 
     for {
        q &lt;- queue
        data &lt;- q.dequeue
     } yield data
}     
</code></pre></div></div>

<p>In the snippet above we use <code class="language-plaintext highlighter-rouge">flatMap</code> (as a <code class="language-plaintext highlighter-rouge">for-comprehension</code>) to obtain the elements stored in the queue. Get comfortable with <code class="language-plaintext highlighter-rouge">flatMap</code>, as with fs2 we will be using it a lot.</p>

<h1 id="beware-infinite-streams">Beware infinite streams</h1>

<p>Streams are useful for many reasons, but one of the common examples is processing an infinite stream: we don’t have enough memory to store infinite data in a <code class="language-plaintext highlighter-rouge">List</code> but with a <code class="language-plaintext highlighter-rouge">Stream</code> we can process an infinite stream correctly. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import cats.effect._
import fs2._

object SampleCode extends App {

  val infiniteStream = Stream.emit(1).repeat.covary[IO].map(_ + 3)

  val output = infiniteStream.compile.toVector.unsafeRunSync()
  println(s"Result &gt;&gt; $output") // prints Result &gt;&gt; Vector(4, 4, 4, 4, ... )

}
</code></pre></div></div>

<p>The snippet above creates an infinite stream of data, emitting the value <code class="language-plaintext highlighter-rouge">1</code>. Every value we emit is then mapped to convert it to <code class="language-plaintext highlighter-rouge">4</code>. The result is a <code class="language-plaintext highlighter-rouge">Vector</code> full of <code class="language-plaintext highlighter-rouge">4</code>. Except I lied and the result of the code above is a non-terminating program.</p>

<p>The reason this happens is the way streams, as a functional programming structure, behave. Each operation in the stream happens sequentially, and previous steps must be completed before the next ones are run. For example if you look at the implementation of <code class="language-plaintext highlighter-rouge">toVector</code>, it uses a <code class="language-plaintext highlighter-rouge">fold</code> behind the scenes. But a <code class="language-plaintext highlighter-rouge">fold</code> of an infinite stream will never complete, as we will always have more data to append.</p>

<p>A way to solve this issue is to limit the data we emit, like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import cats.effect._
import fs2._

object SampleCode extends App {

  val infiniteStream = Stream.emit(1).repeat.covary[IO].map(_ + 3).take(4)

  val output = infiniteStream.compile.toVector.unsafeRunSync()
  println(s"Result &gt;&gt; $output") // prints Result &gt;&gt; Vector(4, 4, 4, 4)

}
</code></pre></div></div>

<p>This program terminates, and emits exactly 4 values.</p>

<p>This may not always be an issue, depending on how we interact with our streams. For example, an Http4s WebSocket will be consuming all the data and sending it to the client, as long as the connection is alive. But there’s the chance we must run an infinite stream, in which case we must consider how to manage it.</p>

<h1 id="flatmap-all-the-things-except-some-streams">Flatmap all the things… except some Streams</h1>

<p>Use of queues is one of the <a href="https://functional-streams-for-scala.github.io/fs2/guide.html#talking-to-the-external-world">recommended ways</a> to integrate data from the external data sources onto your streams. In particular the documentation example shows the following:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2._</span>
<span class="k">import</span> <span class="nn">fs2.async</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span> <span class="nc">Effect</span><span class="o">,</span> <span class="nc">IO</span> <span class="o">}</span>

<span class="k">type</span> <span class="kt">Row</span> <span class="o">=</span> <span class="nc">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>

<span class="k">trait</span> <span class="nc">CSVHandle</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">withRows</span><span class="o">(</span><span class="n">cb</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>,<span class="kt">Row</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">rows</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">h</span><span class="k">:</span> <span class="kt">CSVHandle</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>,<span class="kt">Row</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">q</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">async</span><span class="o">.</span><span class="py">unboundedQueue</span><span class="o">[</span><span class="kt">F</span>,<span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>,<span class="kt">Row</span><span class="o">]])</span>
    <span class="k">_</span> <span class="k">&lt;-</span>  <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span> <span class="o">{</span> <span class="nv">F</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nv">h</span><span class="o">.</span><span class="py">withRows</span><span class="o">(</span><span class="n">e</span> <span class="k">=&gt;</span> <span class="nv">async</span><span class="o">.</span><span class="py">unsafeRunAsync</span><span class="o">(</span><span class="nv">q</span><span class="o">.</span><span class="py">enqueue1</span><span class="o">(</span><span class="n">e</span><span class="o">))(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nv">IO</span><span class="o">.</span><span class="py">unit</span><span class="o">)))</span> <span class="o">}</span>
    <span class="n">row</span> <span class="k">&lt;-</span> <span class="nv">q</span><span class="o">.</span><span class="py">dequeue</span><span class="o">.</span><span class="py">rethrow</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">row</span>
</code></pre></div></div>

<p>where we do a callback to <code class="language-plaintext highlighter-rouge">withRows</code> to enqueue data, and we receive a stream from dequeuing this data. In our codebase we probably want to split the <code class="language-plaintext highlighter-rouge">rows</code> function into several smaller functions, as we may want to process the data in the queue before dequeuing. Let’s do this code split as an exercise.</p>

<p>The code is supposed to work with external streams of data. These may be the input from a WebSocket, or a stream reading from an external source like a Kafka topic. In our example, we can fake the 3rd party data source using a <code class="language-plaintext highlighter-rouge">Scheduler</code> that emits a <code class="language-plaintext highlighter-rouge">String</code> every second:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val streamData: Stream[IO, String] = Scheduler[IO](corePoolSize = 1).flatMap { scheduler =&gt;
  scheduler.awakeEvery[IO](1.second).map(_ =&gt; (System.currentTimeMillis() % 10000).toString)
}
</code></pre></div></div>

<p>Our code will be using a queue to store the data we read from the data source until we process it. This means we need a method that will enqueue data to the queue:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def enqueueData[F[_]](q: Queue[F, String])(implicit F: Effect[F]): Stream[F, Future[Unit]] =
  Stream.eval(
    F.delay(
      streamData
        .map(s =&gt; {
          async.unsafeRunAsync(q.enqueue1(s))(_ =&gt; IO.unit)
        })
        .compile
        .drain
        .unsafeToFuture()
    )
  )
</code></pre></div></div>

<p>Let’s understand what is going on in this method. Our function receives a queue <code class="language-plaintext highlighter-rouge">q</code> as a parameter, which is the queue we will use to store the data as we receive it. When our fake external source of data, <code class="language-plaintext highlighter-rouge">streamData</code>, has a new value available we enqueue the value with <code class="language-plaintext highlighter-rouge">q.enqueue1(s)</code>. But <code class="language-plaintext highlighter-rouge">q.enqueue1(s)</code>, as a good FP citizen, will just return a <code class="language-plaintext highlighter-rouge">F[Unit]</code> without triggering any side effect. We have to explicitly run it with <code class="language-plaintext highlighter-rouge">async.unsafeRunAsync</code> to enqueue the element. You can see the same pattern in the <a href="https://functional-streams-for-scala.github.io/fs2/guide.html#talking-to-the-external-world">documentation</a>.</p>

<p>At this point we have declared our <code class="language-plaintext highlighter-rouge">Stream</code> and the logic to enqueue elements. But the <code class="language-plaintext highlighter-rouge">Stream</code> will do nothing unless we run it! This is where the calls to <code class="language-plaintext highlighter-rouge">compile.drain.unsafeToFuture()</code> become relevant. Without them, our fake stream will not be executed and no element will be added to the queue. The rest of the code is just wrappers to return an <code class="language-plaintext highlighter-rouge">Stream[F, Future[Unit]]</code> as result of executing this function.</p>

<p>Now that we know how to enqueue, let’s provide a mechanism for retrieving data from the queue:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def dequeueData[F[_]](q: Queue[F, String])(implicit F: Effect[F]) = q.dequeue.take(4)
</code></pre></div></div>

<p>A much simpler method. Given a queue, we call <code class="language-plaintext highlighter-rouge">dequeue</code> to obtain a <code class="language-plaintext highlighter-rouge">Stream[F, String]</code>. The <code class="language-plaintext highlighter-rouge">take</code> call here is <em>very</em> important, as we are working with an infinite stream of data. Remember the previous section.</p>

<p>Having a way to enqueue and dequeue, our last requirement is a function that creates a queue and proceeds to call these two functions, so we can get data from our fake external source:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def withQueue[F[_]](implicit F: Effect[F]): Stream[F, String] = {
  val queue: Stream[F, Queue[F, String]] = Stream.eval(async.circularBuffer[F, String](5))

  val enqueueStream = queue.flatMap { q =&gt;
    enqueueData(q)
  }

  val dequeueStream = queue.flatMap { q ⇒
    dequeueData(q)
  }

  dequeueStream.concurrently(enqueueStream)
}
</code></pre></div></div>

<p>In this snippet we create a <code class="language-plaintext highlighter-rouge">queue</code>, which is backed by a circular buffer (to limit memory consumption), and we use that <code class="language-plaintext highlighter-rouge">queue</code> with our previously defined functions <code class="language-plaintext highlighter-rouge">enqueueData</code> and <code class="language-plaintext highlighter-rouge">dequeueData</code>.</p>

<p>The full sample, all together and with the relevant imports and the command to execute it, looks like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import cats.effect.{ Effect, IO }
import fs2._
import fs2.async.mutable.Queue
import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.duration._

object SampleCode extends App {

  val streamData: Stream[IO, String] = Scheduler[IO](corePoolSize = 1).flatMap { scheduler =&gt;
    scheduler.awakeEvery[IO](1.second).map(_ =&gt; (System.currentTimeMillis() % 10000).toString)
  }

  def enqueueData[F[_]](q: Queue[F, String])(implicit F: Effect[F]) =
    Stream.eval(
      F.delay(
        streamData
          .map(s =&gt; {
            async.unsafeRunAsync(q.enqueue1(s))(_ =&gt; IO.unit)
          })
          .compile
          .drain
          .unsafeToFuture()
      )
    )

  def dequeueData[F[_]](q: Queue[F, String])(implicit F: Effect[F]) = q.dequeue.take(4)

  def withQueue[F[_]](implicit F: Effect[F]): Stream[F, String] = {
    val queue: Stream[F, Queue[F, String]] = Stream.eval(async.circularBuffer[F, String](5))

    val enqueueStream = queue.flatMap { q =&gt;
      enqueueData(q)
    }

    val dequeueStream = queue.flatMap { q ⇒
      dequeueData(q)
    }

    dequeueStream.concurrently(enqueueStream)
  }

  val resultQueue = withQueue[IO].compile.toVector.unsafeRunSync()
  println(s"Queue &gt;&gt; $resultQueue") // hangs

}

</code></pre></div></div>

<p>This seems like a reasonable piece of code to manage external sources. Also, this doesn’t work. Running the example will hang the process.</p>

<p>The reason is that <code class="language-plaintext highlighter-rouge">queue</code>, which is a <code class="language-plaintext highlighter-rouge">Stream</code> of <code class="language-plaintext highlighter-rouge">Queue[F, String]</code>, creates new streams on each <code class="language-plaintext highlighter-rouge">flatMap</code>. This means <code class="language-plaintext highlighter-rouge">enqueueStream</code> and <code class="language-plaintext highlighter-rouge">dequeueStream</code> are using different <code class="language-plaintext highlighter-rouge">queue</code> inside the streams, and they don’t have visibility on each other’s data. I found it specially easy to miss this when working with queues and the provided <code class="language-plaintext highlighter-rouge">Streams</code></p>

<p>To get the code working, replace <code class="language-plaintext highlighter-rouge">withQueue</code> with:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">withQueue</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">queue</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Queue</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">async</span><span class="o">.</span><span class="py">circularBuffer</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">](</span><span class="mi">5</span><span class="o">))</span>

    <span class="nv">queue</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">q</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="nv">enqueueStream</span> <span class="k">=</span> <span class="nf">enqueueData</span><span class="o">(</span><span class="n">q</span><span class="o">)</span>

      <span class="k">val</span> <span class="nv">dequeueStream</span> <span class="k">=</span> <span class="nf">dequeueData</span><span class="o">(</span><span class="n">q</span><span class="o">)</span>

      <span class="nv">dequeueStream</span><span class="o">.</span><span class="py">concurrently</span><span class="o">(</span><span class="n">enqueueStream</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>In this new snippet we call the support functions inside <code class="language-plaintext highlighter-rouge">flatMap</code> and return as result of the operation the concatenation of both streams. Please note that the last step is to run the resulting streams in parallel via <code class="language-plaintext highlighter-rouge">concurrently</code>. Without this last step the process won’t work.</p>

<p>The reason is that at the end of the process we will call <code class="language-plaintext highlighter-rouge">compile.drain.unsafeRunSync</code> to execute our stream. Without <code class="language-plaintext highlighter-rouge">concurrently</code>, one of the streams won’t be part of the stream we are executing, and as a consequence the operations associated to it won’t happen: you won’t enqueue or dequeue data. You can try this by just returning one of the streams.</p>

<p>With this new snippet, both operations share the same queue and the result is printed as expected.</p>

<h1 id="topics">Topics</h1>

<p>Topics provide fs2’s implementation of the <a href="https://en.wikipedia.org/wiki/Publish–subscribe_pattern">publish-subscribe</a> pattern. They are extremely useful but, alas, barely documented. They have a twist that makes them interesting to work with compared to other pub sub systems: they are completely side-effect free.</p>

<p>Creating a topic is easy enough:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span> <span class="nc">Effect</span><span class="o">,</span> <span class="nc">IO</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>

<span class="k">object</span> <span class="nc">SampleCode</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">withTopic</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">topicStream</span> <span class="k">=</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">fs2</span><span class="o">.</span><span class="py">async</span><span class="o">.</span><span class="py">topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">](</span><span class="s">"Topic start"</span><span class="o">))</span>

    <span class="nv">topicStream</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">topic</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="nv">publisher</span> <span class="k">=</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="py">repeat</span><span class="o">.</span><span class="py">covary</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">to</span><span class="o">(</span><span class="nv">topic</span><span class="o">.</span><span class="py">publish</span><span class="o">)</span>

      <span class="k">val</span> <span class="nv">subscriber</span> <span class="k">=</span> <span class="nv">topic</span><span class="o">.</span><span class="py">subscribe</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="py">take</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>

      <span class="nv">subscriber</span><span class="o">.</span><span class="py">concurrently</span><span class="o">(</span><span class="n">publisher</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="k">val</span> <span class="nv">resultTopic</span> <span class="k">=</span> <span class="n">withTopic</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">compile</span><span class="o">.</span><span class="py">toVector</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Topic &gt;&gt; $resultTopic"</span><span class="o">)</span> <span class="c1">// prints Topic &gt;&gt; Vector(Topic start, 1, 1, 1)</span>

<span class="o">}</span>
</code></pre></div></div>
<p>Each call to flatMap in this example creates a new topic with its own subscribers and publishers. This works for this example, but we may find a familiar problem if we wanted to reuse that topic to add multiple publishers and subscribers (for example inside an http4s service). Each call to <code class="language-plaintext highlighter-rouge">flatMap</code> would create a new topic, which results in a familiar problem: data isn’t shared across topics, different requests don’t see the same data.</p>

<p>In a previous version of the post we had a solution that was using a map as an intermediate step to store the topic to share between requests. But thanks to <code class="language-plaintext highlighter-rouge">Fabio Labella</code> we have a much nicer solution at hand:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2._</span>
<span class="k">import</span> <span class="nn">fs2.async.mutable.Topic</span>
<span class="k">import</span> <span class="nn">fs2.StreamApp.ExitCode</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">cats.effect._</span>

<span class="k">import</span> <span class="nn">scala.collection.mutable</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">object</span> <span class="nc">SampleCode2</span> <span class="k">extends</span> <span class="nc">StreamApp</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">sharedTopicStream</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Effect</span><span class="o">](</span><span class="n">topicId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">async</span><span class="o">.</span><span class="py">topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">](</span><span class="n">s</span><span class="s">"Topic $topicId start"</span><span class="o">))</span>

  <span class="k">def</span> <span class="nf">addPublisher</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">topic</span><span class="k">:</span> <span class="kt">Topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">],</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="py">covary</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">repeat</span><span class="o">.</span><span class="py">to</span><span class="o">(</span><span class="nv">topic</span><span class="o">.</span><span class="py">publish</span><span class="o">)</span>

  <span class="k">def</span> <span class="nf">addSubscriber</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">topic</span><span class="k">:</span> <span class="kt">Topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">topic</span>
      <span class="o">.</span><span class="py">subscribe</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
      <span class="o">.</span><span class="py">take</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>

  <span class="c1">// a request that adds a publisher to the topic</span>
  <span class="k">def</span> <span class="nf">requestAddPublisher</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">topic</span><span class="k">:</span> <span class="kt">Topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nf">addPublisher</span><span class="o">(</span><span class="n">topic</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span>

  <span class="c1">// a request that adds a subscriber to the topic</span>
  <span class="k">def</span> <span class="nf">requestAddSubscriber</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">topic</span><span class="k">:</span> <span class="kt">Topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nf">addSubscriber</span><span class="o">(</span><span class="n">topic</span><span class="o">).</span><span class="py">to</span><span class="o">(</span><span class="nv">Sink</span><span class="o">.</span><span class="py">showLinesStdOut</span><span class="o">)</span>

  <span class="k">def</span> <span class="nf">stream</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">requestShutdown</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">ExecutionContext.Implicits.global</span>
    <span class="c1">// we simulate  requests that work on a common topic.</span>
    <span class="k">val</span> <span class="nv">sharedTopic</span> <span class="k">=</span> <span class="n">sharedTopicStream</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="s">"sharedTopic"</span><span class="o">)</span>

    <span class="c1">// sharedTopic is passed to your Services, which use it as necessary</span>
    <span class="nv">sharedTopic</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">topic</span> <span class="k">⇒</span>
      <span class="nf">requestAddPublisher</span><span class="o">(</span><span class="s">"publisher1"</span><span class="o">,</span> <span class="n">topic</span><span class="o">)</span> <span class="n">concurrently</span>
      <span class="nf">requestAddPublisher</span><span class="o">(</span><span class="s">"publisher2"</span><span class="o">,</span> <span class="n">topic</span><span class="o">)</span> <span class="n">concurrently</span>
      <span class="nf">requestAddSubscriber</span><span class="o">(</span><span class="n">topic</span><span class="o">)</span> <span class="n">concurrently</span>
      <span class="nf">requestAddSubscriber</span><span class="o">(</span><span class="n">topic</span><span class="o">)</span>

    <span class="o">}.</span><span class="py">drain</span> <span class="o">++</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">emit</span><span class="o">(</span><span class="nv">ExitCode</span><span class="o">.</span><span class="py">Success</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>Please note in the code above the JVM won’t exit after running the example, as we are using a <code class="language-plaintext highlighter-rouge">StreamApp[IO]</code> trait. This is expected behaviour!</p>

<p>The key of the solution is the creation of <code class="language-plaintext highlighter-rouge">sharedTopic</code>, which is then used to provide a common topic to multiple request, which we simulate (to simplify the code in the example) via some function call. This approach removes the need of ugly <code class="language-plaintext highlighter-rouge">unsafeRunSync</code> calls inside the code, and it gives rise to an amazing property: <em>the region you share any given piece of pure mutable state is the same as your call graph, and that makes shared state easy to reason about, unlike its side-effecting counterpart</em></p>

<p>The mistake I made in the previous code sample, and which I’ve been assured is unfortunately quite common, was replicating a pattern from the object-oriented world: storing the topic in a transient structure (a mutable map) as to share it across requests. But, in a functional world, we provide to each function everything we need to maintain referential transparency.</p>

<p>In short: if you need to share data structures, like topics, resist the temptation of using mutable structures to store them, and pass the structure you need as a parameter. At the top of your graph call you will be able to instantiate the necessary instance and share it across</p>

<h1 id="conclusions">Conclusions</h1>

<p>We have reviewed some possible pitfalls we may encounter when we start working with <a href="https://functional-streams-for-scala.github.io/fs2/">fs2</a>. We have provided sample code to demonstrate the problematic code snippets as well as the solution for these issues. Hopefully this will help with the transition to <a href="http://http4s.org">http4s</a> v0.18, specially when working with WebSockets!</p>

<h1 id="acknowledgements">Acknowledgements</h1>

<p>Thanks to Danielle Ashley, <a href="https://twitter.com/davegurnell">Dave Gurnell</a> and <a href="https://twitter.com/d6y">Richard Dallaway</a> for their comments on the draft. Thanks to the <a href="https://gitter.im/functional-streams-for-scala/fs2">fs2 Gitter channel</a> and specially to <a href="https://www.linkedin.com/in/fabiolabella/">Fabio Labella</a> for their help understanding several fs2 concepts. And thanks to Underscore for allowing me to publish this here :)</p>


        </article>

        <hr>

        
          <div class="row">
  <div class="col-sm-4 col-sm-offset-2">
    <h3 class="text-center">
      Like what you're reading?
    </h3>
    <p class="text-center">
      <a href="/blog/newsletters" class="btn btn-primary">
        Join our newsletter
        <span class="icon-uio-chevron-right "></span>
      </a>
    </p>
  </div>
</div>
        

        <hr>

        <h2 class="comments">Comments</h2>

<p>
  We encourage discussion of our blog posts on our <a href="https://gitter.im/underscoreio/scala">Gitter channel</a>.
  Please review our <a href="/terms#comments">Community Guidelines</a> before posting there.
  We encourage discussion in good faith, but do not allow combative, exclusionary, or harassing behaviour. 
  If you have any questions, <a href="/contact">contact us</a>!
</p>

      </section>
    </div>

    <div class="col-md-4">
      <aside class="blog-sidebar">
        <div id="mc_embed_signup" class="blog-sidebar-mailchimp panel panel-gray">
  <div class="panel-body">
    <h4>The Underscore Newsletter</h4>

    <p>Keep up to date! Subscribe to our newsletter for the latest Scala news.</p>

    <form method="post"
          action="http://underscoreconsulting.us3.list-manage.com/subscribe/post?u=a62dbb8a9c32f6c994dfd1111&amp;id=e9817b5369"
              id="mc-embedded-subscribe-form"
            name="mc-embedded-subscribe-form"
           class="validate"
          target="_blank"
      novalidate="">
      <fieldset>
        <div class="row">
          <div class="col-sm-12">
            <div class="form-group">
              <button class="btn btn-primary" id="mc-embedded-subscribe" type="submit" data-goal="click">Keep me posted</button>
            </div>
          </div>
        </div>
      </fieldset>
    </form>

    <p class="text-muted">
      <small>No spam. Unsubscribe at any time. We do not share personal details with third parties.</small>
    </p>

    <p class="text-muted">
      <small><a href="/blog/newsletters">Browse old newsletters to see what you'll get</a></small>
    </p>
  </div>
</div>
<div class="blog-sidebar-promos">
  <h4>Books from Underscore</h4>

  
  <div class="blog-sidebar-promo essential-scala"
     data-book-id="/books/essential-scala">
  <a class="book-title" href="/books/essential-scala">
    <span class="book-icon icon-uio-scala"></span>
    <span class="book-title-text">
      Essential Scala
    </span>

    <span class="pull-right">
      <span class="hidden-md">Read more</span>
      <span class="icon-uio-chevron-right "></span>
    </span>
  </a>
</div>


  
  <div class="blog-sidebar-promo scala-with-cats"
     data-book-id="/books/scala-with-cats">
  <a class="book-title" href="/books/scala-with-cats">
    <span class="book-icon icon-uio-cats"></span>
    <span class="book-title-text">
      Scala with Cats
    </span>

    <span class="pull-right">
      <span class="hidden-md">Read more</span>
      <span class="icon-uio-chevron-right "></span>
    </span>
  </a>
</div>


  
  <div class="blog-sidebar-promo essential-slick"
     data-book-id="/books/essential-slick">
  <a class="book-title" href="/books/essential-slick">
    <span class="book-icon icon-uio-scala"></span>
    <span class="book-title-text">
      Essential Slick
    </span>

    <span class="pull-right">
      <span class="hidden-md">Read more</span>
      <span class="icon-uio-chevron-right "></span>
    </span>
  </a>
</div>


  
  <div class="blog-sidebar-promo shapeless-guide"
     data-book-id="/books/shapeless-guide">
  <a class="book-title" href="/books/shapeless-guide">
    <span class="book-icon icon-uio-shapeless"></span>
    <span class="book-title-text">
      The Type Astronaut's Guide to Shapeless
    </span>

    <span class="pull-right">
      <span class="hidden-md">Read more</span>
      <span class="icon-uio-chevron-right "></span>
    </span>
  </a>
</div>

</div>

<aside class="blog-sidebar-archives">
  <h4>Archives</h4>

  <ul class="list-unstyled">
    
      
        <li class="heading">May 2020</li>
      

      <li><a href="/blog/posts/2020/05/27/scala-with-cats-2.html">Scala with Cats 2</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2020/05/14/porting-and-seq.html">Review Seq matching when porting to 2.13</a></li>
    
      
        
        
        
          <li class="heading">Dec 2019</li>
        
      

      <li><a href="/blog/posts/2019/12/23/talks-roundup.html">Our Talks from 2019</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2019/12/12/tut-to-mdoc.html">Tips for moving from tut to mdoc</a></li>
    
      
        
        
        
          <li class="heading">Jul 2019</li>
        
      

      <li><a href="/blog/posts/2019/07/04/introducing-inner-product.html">Introducing Inner Product</a></li>
    
      
        
        
        
          <li class="heading">Dec 2018</li>
        
      

      <li><a href="/blog/posts/2018/12/21/talks-roundup.html">Our Talks from 2018</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2018/12/12/bridges.html">Bridging Scala and the Front-End</a></li>
    
      
        
        
        
          <li class="heading">May 2018</li>
        
      

      <li><a href="/blog/posts/2018/05/17/modelling-js.html">Modelling JavaScript in Scala with Scala.js</a></li>
    
      
        
        
        
          <li class="heading">Mar 2018</li>
        
      

      <li><a href="/blog/posts/2018/03/20/fs2.html">Tips for working with FS2</a></li>
    
      
        
        
        
          <li class="heading">Dec 2017</li>
        
      

      <li><a href="/blog/posts/2017/12/14/scorex.html">A look at Scorex: a Scala blockchain framework</a></li>
    
      
        
        
        
          <li class="heading">Nov 2017</li>
        
      

      <li><a href="/blog/posts/2017/11/22/scala-with-cats.html">Announcing Scala with Cats</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2017/11/20/newsletter17.html">Newsletter 17: Season for Giving Edition</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2017/11/20/talks-from-team-underscore-at-scalax.html">Talks from Team Underscore at Scala Exchange</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2017/11/15/talks-to-watch-out-for-at-scalax.html">Talks to Watch Out For at Scala Exchange</a></li>
    
      
        
        
        
          <li class="heading">Sep 2017</li>
        
      

      <li><a href="/blog/posts/2017/09/05/review.html">Getting Into Other People's Code</a></li>
    
      
        
        
        
          <li class="heading">Jun 2017</li>
        
      

      <li><a href="/blog/posts/2017/06/02/uniting-church-and-state.html">Uniting Church and State: FP and OO Together</a></li>
    
      
        
        
        
          <li class="heading">May 2017</li>
        
      

      <li><a href="/blog/posts/2017/05/31/newsletter16.html">Newsletter 16: It's Book Time!</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2017/05/29/why-we-open-sourced-our-books.html">Why We Open Sourced our Books</a></li>
    
      
        
        
        
          <li class="heading">Apr 2017</li>
        
      

      <li><a href="/blog/posts/2017/04/11/type-tetris.html">Playing "Type Tetris"
</a></li>
    
      
        
        
        
          <li class="heading">Mar 2017</li>
        
      

      <li><a href="/blog/posts/2017/03/29/free-inject.html">The Free Monad with Multiple Algebras</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2017/03/07/refined-data-config-database.html">Refining your data from configuration to database</a></li>
    
      
        
        
        
          <li class="heading">Jan 2017</li>
        
      

      <li><a href="/blog/posts/2017/01/24/finch-functional-web-development.html">Finch: Functional Web Development</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2017/01/17/newsletter15.html">Newsletter 15: New Events in the New Year</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2017/01/17/agile-awards.html">Barclays Agile Awards 2016</a></li>
    
      
        
        
        
          <li class="heading">Dec 2016</li>
        
      

      <li><a href="/blog/posts/2016/12/16/newsletter14.html">Newsletter 14: Closing the Book on 2016</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2016/12/05/type-lambdas.html">Type lambdas and kind projector</a></li>
    
      
        
        
        
          <li class="heading">Nov 2016</li>
        
      

      <li><a href="/blog/posts/2016/11/24/value-discard.html">Value Discarding</a></li>
    
      
        
        
        
          <li class="heading">Oct 2016</li>
        
      

      <li><a href="/blog/posts/2016/10/11/twenty-two.html">Scala and 22</a></li>
    
      
        
        
        
          <li class="heading">Jul 2016</li>
        
      

      <li><a href="/blog/posts/2016/07/20/speaking-at-scalax.html">Giving a First Talk</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2016/07/20/new-speakers-at-scala-exchange-2016.html">How You Can Help Bring New Speakers and New Ideas to Scala eXchange 2016</a></li>
    
      
        
        
        
          <li class="heading">Jun 2016</li>
        
      

      <li><a href="/blog/posts/2016/06/27/opaque-transparent-interpreters.html">Opaque and Transparent Interpreters</a></li>
    
      
        
        
        
          <li class="heading">Apr 2016</li>
        
      

      <li><a href="/blog/posts/2016/04/21/probabilistic-programming.html">Probabilistic Programming in Scala</a></li>
    
      
        
        
        
          <li class="heading">Mar 2016</li>
        
      

      <li><a href="/blog/posts/2016/03/21/serverless-scale-summit.html">Scala.js is Important for Cloud Services</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2016/03/08/qcon.html">Types Working For You, Not Against You</a></li>
    
      
        
        
        
          <li class="heading">Feb 2016</li>
        
      

      <li><a href="/blog/posts/2016/02/02/advanced-scala-scalaz-to-cats.html">Advanced Scala Scalaz to Cats</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2016/02/01/aws-lambda.html">Scala and AWS Lambda Blueprints</a></li>
    
      
        
        
        
          <li class="heading">Jan 2016</li>
        
      

      <li><a href="/blog/posts/2016/01/19/typelevel-summits.html">Typelevel Summits</a></li>
    
      
        
        
        
          <li class="heading">Dec 2015</li>
        
      

      <li><a href="/blog/posts/2015/12/22/newsletter13.html">Newsletter 13: Christmas Loot Edition</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/12/21/scalax-slick-workshop.html">Video from the Slick Workshop at Scala Exchange 2015</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/12/21/scalax-interpreters-workshop.html">Slides and Code from the Interpreters Workshop at Scala Exchange 2015</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/12/18/tut.html">tut</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/12/18/scala-exchange-highlights.html">Highlights from Scala Exchange 2015</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/12/01/newsletter12.html">Newsletter 12: Scala Exchange</a></li>
    
      
        
        
        
          <li class="heading">Nov 2015</li>
        
      

      <li><a href="/blog/posts/2015/11/19/essential-slick-review-copies.html">Essential Slick Feature Complete and Review Copies Available</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/11/17/why-3x5-is-and-isnt-5x3.html">Why 3&times;5 is and isn't 5&times;3</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/11/09/sbt-commands.html">SBT Tricks</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/11/04/late-binding-and-overloading.html">Late Binding and Overloading in Scala</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/11/03/atom.html">Using the Atom Editor with Scala</a></li>
    
      
        
        
        
          <li class="heading">Oct 2015</li>
        
      

      <li><a href="/blog/posts/2015/10/14/reification.html">Reification, Kleislis, and Stream Libraries</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/10/01/newsletter11.html">Newsletter 11: Books and Boxes</a></li>
    
      
        
        
        
          <li class="heading">Sep 2015</li>
        
      

      <li><a href="/blog/posts/2015/09/16/book-update.html">Updates on the Underscore Books</a></li>
    
      
        
        
        
          <li class="heading">Aug 2015</li>
        
      

      <li><a href="/blog/posts/2015/08/28/essential-slick.html">Essential Slick Updates</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/08/23/slick-getresults.html">Using slickless with Plain SQL</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/08/08/slickless.html">Using shapeless HLists with Slick 3</a></li>
    
      
        
        
        
          <li class="heading">Jul 2015</li>
        
      

      <li><a href="/blog/posts/2015/07/24/diversity.html">You Can Increase Diversity at Scala eXchange</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/07/21/simple-isnt-easy.html">Simple Isn't Easy</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/07/14/upsert.html">Upsert in Slick 3</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/07/03/newsletter10.html">Newsletter 10: Conferences, Cats, and Robots from the Future</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/07/02/annihilators-in-scala.html">Annihilators in Scala: An Example of Type Class Design</a></li>
    
      
        
        
        
          <li class="heading">Jun 2015</li>
        
      

      <li><a href="/blog/posts/2015/06/25/keeping-scala-simple.html">Keeping Scala Simple</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/06/10/scalajs-scaladays.html">Towards Browser and Server Utopia with Scala.js</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/06/10/an-introduction-to-cats.html">An Introduction to Cats</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/06/05/new-speakers-at-scala-exchange-2015.html">New Speakers at Scala Exchange 2015</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/06/04/newsletter9.html">Newsletter 9: Scala Jobs, Slick, Sealed Traits, Strata, and Scala Days</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/06/04/more-on-sealed.html">More on Sealed Traits in Scala</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/06/02/everything-about-sealed.html">Everything You Ever Wanted to Know About Sealed Traits in Scala</a></li>
    
      
        
        
        
          <li class="heading">May 2015</li>
        
      

      <li><a href="/blog/posts/2015/05/28/typechecking-sql.html">Typechecking SQL in Slick and doobie</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/05/15/slick-enrichment.html">Slick Query Enrichment</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/05/14/strata-hadoop-world.html">Strata + Hadoop World London 2015 In Review</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/05/06/essential-slick.html">Introducing Essential Slick</a></li>
    
      
        
        
        
          <li class="heading">Apr 2015</li>
        
      

      <li><a href="/blog/posts/2015/04/30/newsletter8.html">Newsletter 8: Free Monads and Free Courses</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/04/28/monadic-io-laziness-makes-you-free.html">Monadic IO: Laziness Makes You Free</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/04/24/distributed-teams.html">Practices for Distributed Scala Teams</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/04/23/deriving-the-free-monad.html">Deriving the Free Monad</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/04/14/free-monads-are-simple.html">Free Monads Are Simple</a></li>
    
      
        
        
        
          <li class="heading">Mar 2015</li>
        
      

      <li><a href="/blog/posts/2015/03/13/rxlift.html">RxLift: Reactive Web Components with LiftWeb and RxScala</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/03/05/newsletter7.html">Newsletter 7: Error Handling and Two New Books</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/03/05/compositional-music-composition.html">Compositional Music Composition</a></li>
    
      
        
        
        
          <li class="heading">Feb 2015</li>
        
      

      <li><a href="/blog/posts/2015/02/25/creative-scala-released.html">Creative Scala: A New Introduction to Scala</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/02/23/designing-fail-fast-error-handling.html">Designing Fail-Fast Error Handling</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/02/13/error-handling-without-throwing-your-hands-up.html">Error Handling Without Throwing Your Hands Up</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/02/09/newsletter6.html">Newsletter 6: Training and Diversity Online and Worldwide</a></li>
    
      
        
        
        
          <li class="heading">Jan 2015</li>
        
      

      <li><a href="/blog/posts/2015/01/29/rethinking-online-training.html">Rethinking Online Training</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/01/29/diversity-in-training.html">Diversity in Training</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/01/16/lift-26-release.html">Highlights of the Lift Web Framework 2.6 Release</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/01/14/new-speakers-at-scala-exchange.html">Roundup of the New Speakers at Scala Exchange</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2015/01/05/codereview.html">Code Review at Scala eXchange</a></li>
    
      
        
        
        
          <li class="heading">Dec 2014</li>
        
      

      <li><a href="/blog/posts/2014/12/16/essential-scala-and-play-books-available-for-early-access.html">Essential Scala and Play Books Available for Early Access</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/12/05/newsletter5.html">Newsletter 5: Xmas Reading</a></li>
    
      
        
        
        
          <li class="heading">Oct 2014</li>
        
      

      <li><a href="/blog/posts/2014/10/20/newsletter4.html">Newsletter 4</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/10/20/essential-esential-scala-at-hack-the-tower.html">Essential Essential Scala at Hack the Tower</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/10/17/new-speakers-at-scala-exchange.html">New Speakers at Scala Exchange</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/10/02/learn-shapeless-find-500-dollars.html">Learn Shapeless, Find $500</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/10/01/intro-functional-finance.html">Introducing Functional Finance</a></li>
    
      
        
        
        
          <li class="heading">Sep 2014</li>
        
      

      <li><a href="/blog/posts/2014/09/16/response-to-the-typelevel-fork.html">Our Response to the Typelevel fork of Scala</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/09/03/enumerations.html">Scala Enumerations</a></li>
    
      
        
        
        
          <li class="heading">Aug 2014</li>
        
      

      <li><a href="/blog/posts/2014/08/28/tools-to-guide-code-quality.html">Tools to guide code quality</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/08/17/angularjs-vs-react.html">AngularJs vs React</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/08/07/newsletter3.html">Newsletter 3</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/08/07/scala-exchange-nsap-last-call.html">Scala Exchange New Speaker Programme Closing Soon</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/08/05/code-reviews-dont-produce-quality-code.html">Code Reviews Don't Produce Quality Code</a></li>
    
      
        
        
        
          <li class="heading">Jul 2014</li>
        
      

      <li><a href="/blog/posts/2014/07/27/readerwriterstate.html">A Small (Real) Example of the Reader and Writer Monads</a></li>
    
      
        
        
        
          <li class="heading">Jun 2014</li>
        
      

      <li><a href="/blog/posts/2014/06/30/underscores-new-speaker-program.html">Underscore's New Speaker Program for Scala Exchange</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/06/24/scala-days-2014-the-lowdown.html">Scala Days 2014: The Low-down</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/06/21/announcing-underscoreio.html">Announcing underscore.io</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/06/05/lambda.html">Java 8 Crib Sheet for Scala Developers</a></li>
    
      
        
        
        
          <li class="heading">May 2014</li>
        
      

      <li><a href="/blog/posts/2014/05/02/hiring-scala-developers.html">Hiring Scala Developers</a></li>
    
      
        
        
        
          <li class="heading">Apr 2014</li>
        
      

      <li><a href="/blog/posts/2014/04/30/newsletter2.html">Newsletter 2</a></li>
    
      
        
        
        
          <li class="heading">Mar 2014</li>
        
      

      <li><a href="/blog/posts/2014/03/18/newsletter1.html">Newsletter 1</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/03/10/teaching-scala.html">Teaching Scala</a></li>
    
      
        
        
        
          <li class="heading">Jan 2014</li>
        
      

      <li><a href="/blog/posts/2014/01/29/unboxed-tagged-angst.html">Unboxed Tagged Angst</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2014/01/06/crdt.html">Collaborative Text Editing</a></li>
    
      
        
        
        
          <li class="heading">Dec 2013</li>
        
      

      <li><a href="/blog/posts/2013/12/20/scalaz-monad-transformers.html">Scalaz Monad Transformers</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2013/12/20/crdts-for-fun-and-eventual-profit.html">CRDTs for fun and eventual profit</a></li>
    
      
        
        
        
          <li class="heading">Oct 2013</li>
        
      

      <li><a href="/blog/posts/2013/10/01/functional-media-roundup-quality-counts.html">Functional Media Roundup: Quality Counts</a></li>
    
      
        
        
        
          <li class="heading">Aug 2013</li>
        
      

      <li><a href="/blog/posts/2013/08/01/lift.html">Lift Cookbook</a></li>
    
      
        
        
        
          <li class="heading">Jul 2013</li>
        
      

      <li><a href="/blog/posts/2013/07/09/media-panel.html">Functional Programming in Media and Publishing</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2013/07/03/cloudbees.html">CloudBees Service Partner</a></li>
    
      
        
        
        
          <li class="heading">Mar 2013</li>
        
      

      <li><a href="/blog/posts/2013/03/13/streaming-algorithms-preregister.html">Pre-register for Streaming Algorithms Course</a></li>
    
      
        
        
        
          <li class="heading">Oct 2012</li>
        
      

      <li><a href="/blog/posts/2012/10/16/a-tribute-to-phil-bagwell.html">A Tribute to Phil Bagwell</a></li>
    
      
        
        
        
          <li class="heading">Aug 2012</li>
        
      

      <li><a href="/blog/posts/2012/08/01/developer-price.html">Misconceptions about Scala Developer Rates</a></li>
    
      
        
        
        
          <li class="heading">Jul 2012</li>
        
      

      <li><a href="/blog/posts/2012/07/09/another-typeclass.html">Another Small Example of the Type Class Pattern</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2012/07/06/icml-review.html">Review of COLT and ICML</a></li>
    
      
        
        
        
      

      <li><a href="/blog/posts/2012/07/02/kleisli-arrows.html">A Small Example of Kleisli Arrows</a></li>
    
      
        
        
        
          <li class="heading">Jun 2012</li>
        
      

      <li><a href="/blog/posts/2012/06/16/phantom-types.html">A Small Example of Phantom Types</a></li>
    
      
        
        
        
          <li class="heading">May 2012</li>
        
      

      <li><a href="/blog/posts/2012/05/03/typeclasses.html">A Small Example of the Typeclass Pattern</a></li>
    
  </ul>
</aside>

      </aside>
    </div>
  </div>
</section>

<footer>
  <div class="container">
    <div class="text-center">
      <img src="/images/common/footer-brand.png" class="footer-brand" alt="Underscore">
    </div>

    <div class="row sitemap">
      <div class="col-sm-6 col-md-4">
        <h5><a href="/">Underscore</a></h5>
        <ul class="list-unstyled">
          <li><a href="/">Home</a></li>
          <li><a href="/consulting">Our Services</a></li>
          <li><a href="/privacy">Privacy Policy</a></li>
          <li class="currency-select">
            Currency:
            <a href="javascript:void(0)" class="currency-select-usd">USD</a>,
            <a href="javascript:void(0)" class="currency-select-gbp">GBP</a>,
            <a href="javascript:void(0)" class="currency-select-eur">EUR</a>
          </li>
        </ul>
      </div>

      <div class="col-sm-6 col-md-4">
        <h5><a href="/training">Courses and Training</a></h5>
        <ul class="list-unstyled">
          <li><a href="/training/bookings">Book a Course</a></li>
          <li><a href="/training">Course Directory</a></li>
          <li><a href="/training/courses/essential-scala">Essential Scala</a></li>
          <li><a href="/training/courses/advanced-scala">Advanced Scala with Cats</a></li>
        </ul>
      </div>

      <div class="col-sm-6 col-md-4">
        <h5><a href="/contact">Contact</a></h5>
        <ul class="list-unstyled">
          <li><a href="/contact">
            <span class="icon-uio-envelope "></span>
            hello@underscore.io
          </a></li>
          <li><a href="http://twitter.com/underscoreio">
            <span class="icon-uio-twitter "></span>
            @underscoreio
          </a></li>
          <li><a href="/blog/newsletters">
            <span class="icon-uio-public "></span>
            The Underscore Newsletter
          </a></li>
        </ul>
      </div>
    </div>

    <p class="copyright text-center">
      Copyright 2011&ndash;22.
      <br class="visible-xs">
      All rights reserved. <a href="/terms">Terms of use</a>
    </p>
  </div>
</footer>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-29444727-2', 'underscore.io');
      ga('send', 'pageview');
    </script>
  </body>
</html>
